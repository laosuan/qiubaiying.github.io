I"—H<h2 id="1-é‡å†™compareæ–¹æ³•æ’åº">1 é‡å†™compareæ–¹æ³•æ’åº</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// 4 æ’åºä¼˜å…ˆçº§ï¼š 1ç›¸å…³è‡ªé€‰è‚¡å›ç­”æ•°é™åº 2æ‰€æœ‰ç­”æ¡ˆå›ç­”æ•°é™åº</span>
<span class="n">userInvitationDtoList</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="k">new</span> <span class="nc">Comparator</span><span class="o">&lt;</span><span class="nc">UserInvitationDto</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="nc">UserInvitationDto</span> <span class="n">o1</span><span class="o">,</span> <span class="nc">UserInvitationDto</span> <span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">getStockAnswerCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">o2</span><span class="o">.</span><span class="na">getStockAnswerCount</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">getStockAnswerCount</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">o2</span><span class="o">.</span><span class="na">getStockAnswerCount</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">getAnswerCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">o2</span><span class="o">.</span><span class="na">getAnswerCount</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">getAnswerCount</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">o2</span><span class="o">.</span><span class="na">getAnswerCount</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// è¯¾ç¨‹æŒ‰ç…§pvé™åºæ’åº</span>
<span class="n">list</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="k">new</span> <span class="nc">Comparator</span><span class="o">&lt;</span><span class="nc">QuestionOverViewDto</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="nc">QuestionOverViewDto</span> <span class="n">o1</span><span class="o">,</span> <span class="nc">QuestionOverViewDto</span> <span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">o1PageView</span> <span class="o">=</span> <span class="n">o1</span><span class="o">.</span><span class="na">getQuestion</span><span class="o">().</span><span class="na">getPageView</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">o2PageView</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="na">getQuestion</span><span class="o">().</span><span class="na">getPageView</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o1PageView</span> <span class="o">&gt;</span> <span class="n">o2PageView</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o1PageView</span> <span class="o">&lt;</span> <span class="n">o2PageView</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div>

<h2 id="2-åˆ‡é¢">2 åˆ‡é¢</h2>

<p><strong>@AspectJæ”¯æŒä»¥ä¸‹3ç§é€šé…ç¬¦ã€‚</strong></p>

<p>*: åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œä½†å®ƒåªèƒ½åŒ¹é…ä¸Šä¸‹æ–‡ä¸­çš„ä¸€ä¸ªå…ƒç´ ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åŒ¹é…ä»»ä½•public çš„æ–¹æ³•ï¼Œè¿”å›å€¼ï¼Œæ–¹æ³•åï¼Œå’Œå‚æ•°éƒ½åŒ¹é…ä»»æ„ã€‚</span>
<span class="n">execution</span><span class="o">(</span><span class="kd">public</span> <span class="o">*</span> <span class="o">*(..))</span>
<span class="c1">//åŒ¹é…æ‰€æœ‰ä»¥Toç»“å°¾çš„æ–¹æ³•   </span>
<span class="n">execution</span><span class="o">(*</span> <span class="o">*</span><span class="nc">To</span><span class="o">(..))</span>
<span class="mi">1234</span>
</code></pre></div></div>

<p>â€¦ : åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œå¯ä»¥åŒ¹é…ä¸Šä¸‹æ–‡ä¸­çš„å¤šä¸ªå…ƒç´ ï¼Œä½†åœ¨è¡¨ç¤ºç±»æ—¶ï¼Œå¿…é¡»å’Œ*è”åˆä½¿ç”¨ï¼Œåœ¨è¡¨ç¤ºå…¥å‚æ—¶åˆ™å•ç‹¬ä½¿ç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åŒ¹é…com.smartåŒ…ä¸‹ï¼Œä»»ä½• TOTO</span>
<span class="n">within</span><span class="o">(</span><span class="n">com</span><span class="o">.</span> <span class="n">smart</span><span class="o">.</span> <span class="n">service</span><span class="o">..*.*</span><span class="nc">Service</span><span class="o">+)</span>
<span class="mi">12</span>
</code></pre></div></div>

<p>+ï¼šè¡¨ç¤ºæŒ‰ç±»å‹åŒ¹é…æŒ‡å®šç±»çš„æ‰€æœ‰ç±»ï¼Œå¿…é¡»è·Ÿåœ¨ç±»ååé¢ï¼Œå¦‚com.smart.Car+ã€‚ç»§æ‰¿æˆ–æ‰©å±•æŒ‡å®šç±»çš„æ‰€æœ‰ç±»ï¼ŒåŒæ—¶è¿˜åŒ…æ‹¬æŒ‡å®šç±»æœ¬èº«ã€‚</p>

<h2 id="3-ç”¨curlçš„æ ¼å¼æ‰“å°resttemplateçš„httpè¯·æ±‚">3 ç”¨curlçš„æ ¼å¼æ‰“å°restTemplateçš„httpè¯·æ±‚</h2>

<h3 id="1-è°ƒç”¨">1 è°ƒç”¨</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Autowired
RTHelper rtHelper;

/**
 * å¸¦æœ‰é‡è¯•æœºåˆ¶çš„httpè¯·æ±‚
 */
    return parseResponseBody(httpRequestTemplate, flag, resp);
}

/**
 * é€šç”¨urlè¯·æ±‚æ‰“å°curlè¯­å¥ï¼ˆè°ƒè¯•ç”¨ï¼‰
 */
public static &lt;T&gt; Map&lt;String, Object&gt; commonRequestLogCurl(HttpRequestTemplate httpRequestTemplate, String url, String flag,
    HttpMethod httpMethod, Map&lt;String, String&gt; headParam, T postParam) throws CommonCodeException {
    ResponseEntity&lt;Map&gt; resp = RTHelper.newExchange(url, httpMethod, headParam, postParam, Map.class);
    return parseResponseBody(httpRequestTemplate, flag, resp);
} ### 2 å·¥å…·ç±»
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package com.gf.ask.rest.util;

import static org.springframework.http.MediaType.APPLICATION_FORM_URLENCODED;
import static org.springframework.http.MediaType.APPLICATION_FORM_URLENCODED_VALUE;

import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.web.client.RestTemplate;

import com.gf.ask.rest.JsonHelper;

/**
 * @Auther: liuxuan
 * @Date: 2020/12/17 14:42
 * @Description:
 */
@Component
public class RTHelper {

    private static final long serialVersionUID = 4726784355951323347L;

    protected static final Logger logger = LoggerFactory.getLogger(RTHelper.class);

    private static MediaType mediaType = new MediaType("application", "json", Charset.forName("UTF-8"));

    @Autowired
    private RestTemplate restTemplate;

    /**
     * getç±»å‹Paramsè¯·æ±‚
     * ä¸ºurl?xxx=yyy&amp;aaa=bbbç±»å‹
     * @param &lt;R&gt;
     * @param url
     * @param httpHeaders å¯ä»¥ä¸ºnull
     * @param params
     * @param responseType
     */
    public &lt;R&gt; ResponseEntity&lt;R&gt; get(String url, HttpHeaders httpHeaders, Map&lt;String, Object&gt; params, Class&lt;R&gt; responseType) throws Exception {
        StringBuilder urlSuffix = new StringBuilder();
        LinkedMultiValueMap&lt;String, Object&gt; paramsMultiValueMap = new LinkedMultiValueMap();
        if (!CollectionUtils.isEmpty(params)) {
            urlSuffix.append("?");
            params.forEach(paramsMultiValueMap::add);
        }
        convertMapHttpParam(paramsMultiValueMap, urlSuffix);
        return exchange(url + urlSuffix.toString(), HttpMethod.GET, httpHeaders, null, responseType);
    }

    static private void convertMapHttpParam(LinkedMultiValueMap&lt;String, Object&gt; params, StringBuilder urlSuffix) {
        if (!CollectionUtils.isEmpty(params)) {
            List&lt;String&gt; paramList = new ArrayList&lt;&gt;();
            params.forEach((k, v) -&gt; paramList.add(k + "=" + (CollectionUtils.isEmpty(v) ? "" : String.valueOf(v.get(0)))));
            urlSuffix.append(StringUtils.join(paramList, "&amp;"));
        }
    }

    /**
     * getç±»å‹pathè¯·æ±‚
     * ä¸ºurl/{1}/{2}
     * @param url
     * @param httpHeaders å¯ä»¥ä¸ºnull
     * @param params è·¯å¾„è¯·æ±‚å‚æ•°,æ¯”å¦‚/{1}/{2},listé¡ºåºä»£è¡¨urlå†…éƒ¨è¯·æ±‚è·¯å¾„ ä¸èƒ½ä½¿ç”¨Collections.singletonList,å¦‚æœä¸ºç©ºCollections.EMPTY_LIST åˆ™æ˜¯æ™®é€šgetè¯·æ±‚
     * @param responseType
     * @param &lt;R&gt;
     * @return
     */
    public &lt;R&gt; ResponseEntity&lt;R&gt; get(String url, HttpHeaders httpHeaders, List&lt;Object&gt; params, Class&lt;R&gt; responseType) throws Exception {
        StringBuilder urlSuffix = new StringBuilder();
        if (!CollectionUtils.isEmpty(params)) {
            for (int i = 0; i &lt; params.size(); i++) {
                params.set(i, String.valueOf(params.get(i)));
            }
            if (!url.endsWith("/")) {
                urlSuffix.append("/");
            }
            urlSuffix.append(StringUtils.join(params, "/"));
        }
        return exchange(url + urlSuffix.toString(), HttpMethod.GET, httpHeaders, null, responseType);
    }

    /**
     * jsonç±»å‹è¯·æ±‚ application/json;charset=UTF-8
     * @param url
     * @param httpHeaders
     * @param obj å®ä½“å¯¹è±¡æˆ–è€…map
     * @param responseType
     * @param &lt;R&gt;
     * @return
     */
    public &lt;R&gt; ResponseEntity&lt;R&gt; json(String url, HttpHeaders httpHeaders, Object obj, Class&lt;R&gt; responseType) throws Exception {
        httpHeaders.setContentType(mediaType);
        return exchange(url, HttpMethod.POST, httpHeaders, obj, responseType);
    }

    /**
     * formè¡¨å•ç±»å‹è¯·æ±‚ application/x-www-form-urlencoded
     * @param url
     * @param httpHeaders
     * @param obj å®ä½“å¯¹è±¡æˆ–è€…map
     * @param responseType
     * @param &lt;R&gt;
     * @return
     */
    public &lt;R&gt; ResponseEntity&lt;R&gt; form(String url, HttpHeaders httpHeaders, Object obj, Class&lt;R&gt; responseType) throws Exception {
        httpHeaders.setContentType(APPLICATION_FORM_URLENCODED);
        LinkedMultiValueMap objFormParam = new LinkedMultiValueMap();
        if (obj != null) {
            Map&lt;String, Object&gt; objMap = JsonHelper.json2Object(JsonHelper.object2Json(obj), Map.class);
            objMap.remove(serialVersionUID);
            objMap.forEach((k, v) -&gt; objFormParam.add(k, v));
        }
        return exchange(url, HttpMethod.POST, httpHeaders, objFormParam, responseType);
    }

    /**
     * formè¡¨å•ç±»å‹è¯·æ±‚ åŒä¸Š
     * @param url
     * @param obj å®ä½“å¯¹è±¡æˆ–è€…map
     * @param responseType
     * @param &lt;R&gt;
     * @return
     */
    public &lt;R&gt; ResponseEntity&lt;R&gt; form(String url, Object obj, Class&lt;R&gt; responseType) throws Exception {
        HttpHeaders httpHeaders = new HttpHeaders();
        httpHeaders.setContentType(APPLICATION_FORM_URLENCODED);
        return form(url, httpHeaders, obj, responseType);
    }

    /**
     * å¤„ç†è¯·æ±‚ä»¥åŠæ—¥å¿—
     * @param url
     * @param httpMethod
     * @param httpHeaders
     * @param body ä¸èƒ½ä¸ºstring
     * @param responseType
     * @param &lt;R&gt;
     * @return
     */
    public &lt;R&gt; ResponseEntity&lt;R&gt; exchange(String url, HttpMethod httpMethod, HttpHeaders httpHeaders, Object body, Class&lt;R&gt; responseType) throws Exception {

        HttpEntity&lt;Object&gt; httpEntity = new HttpEntity&lt;&gt;(body, httpHeaders);

        StringBuilder restLogStr = new StringBuilder();

        setCurlLog(restLogStr, url, httpMethod, httpHeaders, body);

        ResponseEntity&lt;R&gt; exchange;

        try {
            exchange = restTemplate.exchange(url, httpMethod, httpEntity, responseType);
            setRespLog(restLogStr, exchange);

        } catch (Exception e) {
            setExceptionLog(restLogStr, e);
            throw new Exception(e);
        } finally {
            logger.info(String.valueOf(restLogStr));
        }
        return exchange;
    }

    /**
     * å¤„ç†è¯·æ±‚ä»¥åŠæ—¥å¿—curl
     * ä½¿ç”¨ï¼š
     *     @Autowired
     *     private RTHelper rtHelper;
     * ResponseEntity&lt;Map&gt; resp = rtHelper.newExchange(requestListUrl, HttpMethod.GET, null, null, Map.class);
     * @return
     */
    public static &lt;T&gt; ResponseEntity&lt;Map&gt; newExchange(String url, HttpMethod httpMethod, Map&lt;String, String&gt; headParam, T postParam, Class&lt;Map&gt; responseType) {
        logger.info("url = {}", url);
        HttpHeaders httpHeaders = new HttpHeaders();
        if (headParam != null) {
            httpHeaders.setAll(headParam);
        }

        HttpEntity&lt;T&gt; entity = new HttpEntity&lt;T&gt;(postParam, httpHeaders);

        // HttpEntity&lt;Object&gt; httpEntity = new HttpEntity&lt;&gt;(body, httpHeaders);

        StringBuilder restLogStr = new StringBuilder();

        setCurlLog(restLogStr, url, httpMethod, httpHeaders, postParam);

        ResponseEntity&lt;Map&gt; exchange = null;
        HttpComponentsClientHttpRequestFactory clientHttpRequestFactory = new HttpComponentsClientHttpRequestFactory();
        RestTemplate restTemplate = new RestTemplate(clientHttpRequestFactory);
        try {
            exchange = restTemplate.exchange(url, httpMethod, entity, responseType);
            setRespLog(restLogStr, exchange);

        } catch (Exception e) {
            setExceptionLog(restLogStr, e);
            // throw new Exception(e);
        } finally {
            logger.info(String.valueOf(restLogStr));
        }
        return exchange;
    }

    /**
     * è®¾ç½®curlæ—¥å¿—
     * @param restLog
     * @param url
     * @param httpMethod
     * @param httpHeaders
     * @param body
     */
    static private void setCurlLog(StringBuilder restLog, String url, HttpMethod httpMethod, HttpHeaders httpHeaders, Object body) {
        String methodName = httpMethod.name();
        StringBuilder logTag = new StringBuilder();
        logTag.append("\ncurl -X ").append(methodName).append(" \\\n");
        logTag.append("  ").append(url).append(" \\\n");

        if (!CollectionUtils.isEmpty(httpHeaders)) {
            httpHeaders.forEach((k, v) -&gt; logTag.append("  -H '").append(k).append(": ").append(v.get(0)).append("' \\\n"));
        }

        MediaType contentType = httpHeaders.getContentType();
        if (body != null) {

            if (contentType != null &amp;&amp; !StringUtils.isEmpty(contentType.toString())
                &amp;&amp; APPLICATION_FORM_URLENCODED_VALUE.equals(contentType.toString())) {
                LinkedMultiValueMap&lt;String, Object&gt; bodyParam = (LinkedMultiValueMap) body;
                // bodyParam.remove(TAG_SERIALVERSIONUID);
                logTag.append("  -d '");
                convertMapHttpParam(bodyParam, logTag);
                logTag.append("'");
            } else {
                logTag.append("--header 'Content-Type: application/json'").append(" \\\n");;
                String bodyString = JsonHelper.object2Json(body);
                logTag.append("  -d '").append(bodyString).append("'");
            }
        }

        String curlStr = String.valueOf(logTag);
        if (curlStr.endsWith(" \\\n")) {
            curlStr = curlStr.substring(0, curlStr.length() - 3);
        }
        restLog.append(curlStr).append("\n");
    }

    /**
     * è®¾ç½®å¼‚å¸¸æ—¥å¿—
     * @param restLog
     * @param e
     */
    static private void setExceptionLog(StringBuilder restLog, Exception e) {
        restLog.append("Exception:").append(e.getMessage()).append("\n");
    }

    /**
     * è®¾ç½®å“åº”æ—¥å¿—
     * @param restLog
     * @param exchange
     * @param &lt;R&gt;
     */
    static private &lt;R&gt; void setRespLog(StringBuilder restLog, ResponseEntity&lt;R&gt; exchange) {
        R body = exchange.getBody();
        restLog.append("Response code:'").append(exchange.getStatusCode()).append("',message:'");
        if (body instanceof String) {
            restLog.append(body);
        } else {
            restLog.append(JsonHelper.object2Json(body));
        }
        restLog.append("'\n");
    }
}
</code></pre></div></div>
:ET